# development tests
# - deployment on mobapp-srv.minesparis.psl.eu
# - api at https://<app>.mobapp.minesparis.psl.eu/api/<route>

import os
import logging
import psycopg
import utils
import FlaskSimpleAuth as fsa

assert "APP_NAME" in os.environ, "app requires env APP_NAME"
assert "APP_SECRET" in os.environ, "app requires env APP_SECRET"

name = os.environ["APP_NAME"]

APP_USERS = True
APP_TESTING = False
APP_LOGGING_LEVEL = logging.INFO

# add some FSA-* headers in the responses
FSA_MODE = "dev"
FSA_ADD_HEADERS = { "Application": name }
FSA_CORS = True
FSA_CORS_OPTS = { "max_age": 3600 }

# 4xx and 5xx responses are json: {"error": "some explanation..."}
FSA_ERROR_RESPONSE = "json:error"

# work around idle in transaction issue
FSA_JSON_STREAMING = False

# authentication
FSA_AUTH = "password"
FSA_AUTH_DEFAULT = "token"
FSA_PARAM_USER = "login"
FSA_PARAM_PASS = "password"
FSA_TOKEN_SECRET = os.environ["APP_SECRET"]
FSA_TOKEN_DELAY = 24 * 60.0  # 24 hours

# password quality settings
FSA_PASSWORD_LENGTH = 4
FSA_PASSWORD_RE = [ r"[a-zA-Z]", r"[0-9]", r"[^a-zA-Z0-9]" ]

FSA_PATH_CHECK = fsa.checkPath

# proxy pool configuration
# NOTE beware of the max number of threads allowed by the WSGI server.
#      if #threads == max size, this timeout here is ineffective
# NOTE see further hook configurations directly in "database.py"
POOL = {
    "delay": 5.0,               # house keeping every 5 seconds
    "health_freq": 1,           # health check every round
    "max_size": 2,              # create up to 2 connections
    "min_size": 0,              # no permanent connection
    "timeout": 0.5,             # ineffective if #threads == max_size
    "max_use": 100000,          # force reconnect from time to time
    "max_avail_delay": 60.0,    # kill connections unused for one minute
    "max_using_delay": 5.0,     # kill connections being used for over 5 seconds
    "log_level": logging.INFO,  # set log verbosity
}

# database connection, credentials in ~/.pgpass
DATABASE = {
    "db": "postgres",
    "queries": [ "queries.sql" ],
    "conn": f"host=pagode user={name} dbname={name} application_name={name}-app",
    "exception": utils.dbex,
    "debug": False,
    "row_factory": psycopg.rows.dict_row,
}

# media configuration for file uploads
MEDIA_CONFIG = {
    "allowed_extensions": {"jpg", "jpeg", "png", "gif", "webp"},
    "max_file_size": 15 * 1024 * 1024,  # 15MB in bytes
    "default_avatar_url": "media/user/profile/default.png",  # Default avatar when user has none
}
