# tests on "localhost"

import os
import logging
import psycopg
import utils
import FlaskSimpleAuth as fsa

# mandatory environment variables
assert "APP_NAME" in os.environ, "app requires env APP_NAME"
assert "APP_SECRET" in os.environ, "app requires env APP_SECRET"

name = os.environ["APP_NAME"]

#
# Application internal configuration
#
# activate /users routes
APP_USERS = True
# activate /uptime route
APP_TESTING = True
# raise logging debug level
APP_LOGGING_LEVEL = logging.DEBUG

#
# FlaskSimpleAuth configuration
#
# see: https://zx80.github.io/flask-simple-auth/CONFIG.html
#

# FSA_MODE = "debug4"  ## MAX DEBUG
FSA_MODE = "debug2"
FSA_ERROR_RESPONSE = "json:error"
FSA_ADD_HEADERS = { "Application": name }
FSA_PATH_CHECK = fsa.checkPath
FSA_JSON_STREAMING = False
FSA_CACHE = None  # disable caching for easier debug

# authentication
FSA_AUTH = "password"       # token, basic, param, none
# comment out next line to allow any authentication scheme
FSA_AUTH_DEFAULT = "token"  # default authentication scheme, change on route with auth=â€¦
FSA_PARAM_USER = "login"
FSA_PARAM_PASS = "password"
FSA_TOKEN_SECRET = os.environ["APP_SECRET"]

# security
FSA_CORS = True
FSA_CORS_OPTS = { "max_age": 3600 }
# password quality settings are minimal for testing, empty passes are rejected
FSA_PASSWORD_LENGTH = 1
# FSA_PASSWORD_RE = [ r"[a-zA-Z]", r"[0-9]", r"[-@?,;:!_=+/*]" ]

# proxy internal pool configuration
POOL = {
    "delay": 10.0,              # house keeping every 10 seconds
    "health_freq": 2,           # health check every other round
    "max_size": 2,              # create up to 2 connections
    "min_size": 0,              # no permanent connection
    "timeout": 0.5,             # ineffective if #threads == max_size
    "max_use": 10000,           # force reconnect from time to time (quite short)
    "max_avail_delay": 120.0,   # kill connections unused for 120 seconds
    "max_using_delay": 10.0,    # kill connections being used for over 10 seconds
    "log_level": logging.INFO,  # set log verbosity
}

# media and file upload configuration


# database connection configuration
DATABASE = {
    "db": "postgres",                      # aiosql database (with psycopg)
    "queries": [ "queries.sql" ],          # aiosql definition of queries
    "conn": f"host=/var/run/postgresql dbname={name}",  # anodb connection info string
    "exception": utils.dbex,               # anodb expression filter
    "debug": False,                        # anodb debug mode
    "row_factory": psycopg.rows.dict_row,  # psycopg returns dict
}
# Flask Simple Auth Configuration
# See: https://github.com/zx80/flask-simple-auth



# Password Policy
FSA_PASSWORD_LENGTH = 8
FSA_PASSWORD_RE = [
    r"[A-Z]",  # at least one uppercase
    r"[a-z]",  # at least one lowercase
    r"[0-9]",  # at least one digit
]

# Cache Settings
FSA_CACHE = "ttl"
FSA_CACHE_SIZE = 1000

# Media Configuration
MEDIA_CONFIG = {
    # Allowed file extensions for different media types
    # Avatar images: only image formats
    "avatar_extensions": {"jpg", "jpeg", "png", "gif", "webp"},
    
    # PAPS media: images and videos
    "paps_extensions": {
        # Images
        "jpg", "jpeg", "png", "gif", "webp",
        # Videos
        "mp4", "avi", "mov", "mkv", "webm"
    },
    
    # Combined allowed extensions (union of all above)
    "allowed_extensions": {
        "jpg", "jpeg", "png", "gif", "webp",
        "mp4", "avi", "mov", "mkv", "webm"
    },
    
    # File size limits
    "max_avatar_size": 5 * 1024 * 1024,      # 5MB for avatars
    "max_paps_media_size": 50 * 1024 * 1024, # 50MB for PAPS media (videos)
    "max_file_size": 50 * 1024 * 1024,       # Default max size
    
    # Default avatar URL
    "default_avatar_url": "/media/user/profile/avatar.png"
}

# CORS Settings (if needed for frontend)
# CORS_ORIGINS = ["http://localhost:3000", "http://localhost:5173"]

# Rate Limiting (if implementing)
# RATELIMIT_STORAGE_URL = "memory://"